/**
 * @author Maksym Palii
 * @brief Sine wave generation (collapse at 196Hz, it is impossible to generate higher frequencies)
 * @version 1.0
 * @date 2024 September 05
 */

#define F_CPU (16000000UL)
#define BAUD_RATE (9600UL)

#include "drivers/gpio.h"   
#include "drivers/uart.h"
#include "drivers/timer0.h"
#include "drivers/timer1.h"
#include <avr/interrupt.h>

const int8_t sine_table[] = 
{
    0, 2, 4, 7, 9, 12, 14, 17, 19, 21, 24, 26, 29, 31, 33, 35, 38, 40, 42, 44, 47, 49, 51, 53, 55, 57, 59, 61, 63, 65, 67, 68, 70, 72, 74, 75, 77, 78, 80, 81, 83, 84, 85, 87, 88, 89, 90, 91, 92, 93, 94, 94, 95, 96, 97, 97, 98, 98, 98, 99, 99, 99, 99, 99,
    100, 99, 99, 99, 99, 99, 98, 98, 98, 97, 97, 96, 95, 94, 94, 93, 92, 91, 90, 89, 88, 87, 85, 84, 83, 81, 80, 78, 77, 75, 74, 72, 70, 68, 67, 65, 63, 61, 59, 57, 55, 53, 51, 49, 47, 44, 42, 40, 38, 35, 33, 31, 29, 26, 24, 21, 19, 17, 14, 12, 9, 7, 4, 2,
    0, -2, -4, -7, -9, -12, -14, -17, -19, -21, -24, -26, -29, -31, -33, -35, -38, -40, -42, -44, -47, -49, -51, -53, -55, -57, -59, -61, -63, -65, -67, -68, -70, -72, -74, -75, -77, -78, -80, -81, -83, -84, -85, -87, -88, -89, -90, -91, -92, -93, -94, -94, -95, -96, -97, -97, -98, -98, -98, -99, -99, -99, -99, -99,
    -100, -99, -99, -99, -99, -99, -98, -98, -98, -97, -97, -96, -95, -94, -94, -93, -92, -91, -90, -89, -88, -87, -85, -84, -83, -81, -80, -78, -77, -75, -74, -72, -70, -68, -67, -65, -63, -61, -59, -57, -55, -53, -51, -49, -47, -44, -42, -40, -38, -35, -33, -31, -29, -26, -24, -21, -19, -17, -14, -12, -9, -7, -4, -2
};

uint8_t i = 0;

ISR (TIMER1_COMPA_vect)
{
    int8_t duty = 127 + (sine_table[i] * 127 / 100);
    set_duty(duty);
    i++;
}

int main(void) 
{
    init_gpio();
    init_uart();
    init_timer0();
    init_timer1();
    sei();

    uart_transmit("Start up...\r\n");

    while (true);
}   
  